name: Prompt History Snapshot

on:
  schedule:
    - cron: '*/10 * * * *' # every 10 minutes
  workflow_dispatch:

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.15.1'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: pnpm

      - name: Load environment variables (prefer .env.root.local, fallback to .env.root.example)
        run: |
          if [ -f .env.root.local ]; then
            echo "Using .env.root.local"
            export $(grep -v '^#' .env.root.local | xargs)
          elif [ -f .env.root.example ]; then
            echo ".env.root.local not found, falling back to .env.root.example"
            export $(grep -v '^#' .env.root.example | xargs)
          else
            echo "No root env file found (.env.root.local or .env.root.example)"
          fi

      - name: Make ci-git-config available and configure git (safe dirs / user)
        run: |
          if [ -f ./scripts/ci-git-config.sh ]; then
            chmod +x ./scripts/ci-git-config.sh || true
            ./scripts/ci-git-config.sh
          else
            echo "scripts/ci-git-config.sh not found; skipping git config step"
          fi

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run snapshot script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pnpm snapshot:prompts

      - name: Commit and push prompt history (if changes)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          git add prompt-history || true
          if ! git diff --staged --quiet; then
            git commit -m "chore(prompt-history): snapshot $(date -u +'%Y-%m-%d_%H-%M-%S')"
            git push origin HEAD:foundations
          else
            echo "No changes to prompt-history"
          fi